<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Palworld config editor</title>
    <link rel="icon" href="{{url_for('static', filename='favicon.svg')}}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

</head>
<body>
<iframe name="dummyframe" id="dummyframe" style="display: none;"></iframe>
<div class="container-fluid">
    <div class="row">
        <div class="col">
            <nav class="d-flex flex-wrap justify-content-between align-items-center pb-3 mb-4 pt-3 border-bottom">
                <div class="col-md-4 d-flex align-items-center">
                    <a href="/" class="text-decoration-none text-reset">
                        <h1 class="h3 mb-3 mb-md-0">Palworld config editor</h1>
                    </a>
                </div>

                <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
                    <li class="ms-3">
                        <button title="Use dark mode" id="dark" class="theme-switcher btn btn-sm btn-default">
                            <i style="font-size: 1.5rem;" class="bi bi-moon"></i>
                        </button>
                    </li>
                    <li class="ms-3">
                        <button title="Use dark mode" id="light"
                                class="theme-switcher btn btn-sm btn-default text-secondary">
                            <i style="font-size: 1.5rem;" class="bi bi-sun"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-4 offset-4">
            <div id="successSave" class="alert alert-info text-center d-none" role="alert">
                Saved config to server
            </div>
            <div id="successDefaults" class="alert alert-info text-center d-none" role="alert">
                Loaded default config values
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-8 offset-0 offset-md-1">
            <form name="configForm" action="/" method="post" target="dummyframe">
                <input type="hidden" id="submitType" name="submitType" value="">
                {% for section in defaults %}
                <div class="container border rounded m-3 p-3 pb-0">
                    <div class="row">
                        <h2 class="h4">{{ section.section_displayname }}</h2>
                    </div>
                    <div class="row text-secondary mb-4">
                        <span class="h5">{{ section.section_description }}</span>
                    </div>
                    <div class="row">
                        <div class="container">
                            {% for setting in section.settings %}
                            <div class="row mb-3">
                                <div class="col-12 col-md-3">
                                    <label for="{{ setting.setting_name }}"><b>
                                        {{ setting.setting_displayname }}
                                        {% if 'setting_required' in setting and setting.setting_required %}*{% endif %}
                                    </b></label><br>
                                    <span>{{ setting.setting_description }}</span>
                                </div>
                                <div class="col mb-3">
                                    {% if setting.setting_type != "select" %}
                                    <div class="input-group mb-3">
                                        <input class="form-control"
                                               type="{{ setting.setting_type }}"
                                               {% if 'setting_step' in setting %}step="{{ setting.setting_step }}" {%
                                        endif
                                        %}
                                        {% if 'setting_min' in setting %}min="{{ setting.setting_min }}" {% endif %}
                                        {% if 'setting_max' in setting %}max="{{ setting.setting_max }}" {% endif %}
                                        {% if 'setting_required' in setting and setting.setting_required %}required{%
                                        endif
                                        %}
                                        value="{{ setting.setting_default }}"
                                        id="{{ setting.setting_name }}"
                                        name="{{ setting.setting_name }}"
                                        >
                                        {% if 'setting_suffix' in setting %}
                                        <span class="input-group-text">{{ setting.setting_suffix }}</span>
                                        {% endif %}
                                    </div>

                                    {% else %}
                                    <select class="form-select"
                                            id="{{ setting.setting_name }}"
                                            name="{{ setting.setting_name }}"
                                    >
                                        {% for option in setting.setting_options %}
                                        <option {% if setting.setting_default== option.value %}selected{% endif %}
                                                value="{{ option.value }}">{{ option.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% endif %}
                                </div>
                                <div class="col-1 text-center">
                                    {% if 'setting_min' in setting %}<span><b>min</b> {{ setting.setting_min }}</span>{%
                                    endif
                                    %}
                                </div>
                                <div class="col-1 text-center">
                                    {% if 'setting_max' in setting %}<span><b>max</b> {{ setting.setting_max }}</span>{%
                                    endif
                                    %}
                                </div>
                                <div class="col-2 text-center text-break">
                                    {% if setting.setting_default != '' %}<span><b>default</b> {{ setting.setting_default }}</span>{%
                                    endif
                                    %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
                {% endfor %}
            </form>
        </div>
        <div class="col-12 col-md-2 sticky-md-top" style="height: 100%;">
            <div class="border rounded m-3 px-3 py-4 text-center">
                <span class="h4">Options</span>
                <button type="button" class="d-none btn btn-lg btn-outline-success my-3 w-100" data-bs-toggle="modal"
                        data-bs-target="#saveToServerModal">
                    Save to server
                </button>
                <button type="button" onclick="submitForm('exportINI')"
                        class="btn btn-lg btn-outline-success my-3 w-100" style="width: 100%">Download ini
                </button>
                <button type="button" onclick="submitForm('exportSAV')"
                        class="d-none btn btn-lg btn-outline-success mb-3 w-100" style="width: 100%">Download sav
                </button>
                <button type="button" class="d-none btn btn-lg btn-outline-danger w-100" data-bs-toggle="modal"
                        data-bs-target="#loadDefaultsModal">
                    Load defaults
                </button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
                <div class="col-md-4 d-flex align-items-center">
                    <span class="mb-3 mb-md-0 text-body-secondary">© 2024 Luke Hohlin</span>
                </div>

                <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
                    <li class="ms-3">
                        <a class="text-body-secondary" href="https://github.com/Tctcl/palworld_config_editor"
                           target=”_blank”>
                            <i style="font-size: 1.5rem;" class="bi bi-github"></i>
                        </a>
                    </li>
                </ul>
            </footer>
        </div>
    </div>
    <!-- Save to server Modal -->
    <div class="modal fade" id="saveToServerModal" tabindex="-1" aria-labelledby="saveToServerModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="saveToServerModalLabel">Save config to server</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Saving this config to the server is a <b>destructive</b> action and will <b>overwrite</b> your
                    current config.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" onclick="submitForm('saveToServer')" class="btn btn-success">Save</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Load defaults Modal -->
    <div class="modal fade" id="loadDefaultsModal" tabindex="-1" aria-labelledby="loadDefaultsModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="loadDefaultsModalLabel">Load default config</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Loading the default config is a <b>destructive</b> action and will <b>overwrite</b> your current
                    config.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" onclick="submitForm('loadDefaults')" class="btn btn-danger">Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let leaveIsFormControlled = false;
        let inputsChanged = false;

        function submitForm(action) {
            document.querySelector('#submitType').value = action;
            console.log(document.querySelector('#submitType'));
            document.configForm.submit();
            leaveIsFormControlled = true;
            if (action === 'saveToServer') {
                location.replace("/?action=save");
            } else if (action === 'loadDefaults') {
                location.replace("/?action=defaults");
            }
        }

        function setTheme(mode = 'auto') {
            const userMode = localStorage.getItem('bs-theme');
            const sysMode = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
            const useSystem = mode === 'system' || (userMode != null && mode === 'auto');
            const storageMode = !useSystem && userMode != null ? userMode : sysMode;
            const newMode = mode === 'auto' || mode === 'system' ? storageMode : mode;


            if (useSystem) {
                localStorage.removeItem('bs-theme');
            } else {
                localStorage.setItem('bs-theme', newMode);
            }

            if (newMode === "dark") {
                document.querySelector('#light').classList.add('text-secondary')
                document.querySelector('#dark').classList.remove('text-secondary')
            } else {
                document.querySelector('#dark').classList.add('text-secondary')
                document.querySelector('#light').classList.remove('text-secondary')
            }

            document.documentElement.setAttribute('data-bs-theme', newMode);
        }

        setTheme();
        document.querySelectorAll('.theme-switcher').forEach(e => e.addEventListener('click', () => setTheme(e.id)));
        window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => setTheme('system'));

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        if (params.action === 'save') {
            console.log('#successSave');
            document.querySelector('#successSave').classList.remove('d-none');
        } else if (params.action === 'defaults') {
            console.log('#successDefaults');
            document.querySelector('#successDefaults').classList.remove('d-none');
        }

        window.addEventListener('beforeunload', function (event) {
            if (!leaveIsFormControlled && inputsChanged) {
                event.preventDefault();
                return 'Are you sure you want to leave?'
            }
        });

        document.addEventListener('input', () => {
            inputsChanged = true;
        })
    </script>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>
</html>